<!DOCTYPE html>
<html lang="en">

<head>
    <script src="assets/js/config.js?v=1.0.9.9"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="https://eximpe.com/EximPe.webp">
    <title>EximPe Integrations</title>

    <link rel="stylesheet" href="assets/css/fontawesome-all.min.css?v=1.0.9.9">
    <link rel="stylesheet" href="assets/css/index.css?v=1.0.9.9">
    <link rel="stylesheet" href="assets/css/mobile-nav.css?v=1.0.9.9">
</head>

<body>
    <div class="container">
        <div class="header-hero">
            <div class="logo-circle">
                <svg width="32" height="32" viewBox="0 0 28 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M27.9766 0.193437L17.3616 11.8518L11.7609 6.4086H3.9584L13.6276 15.9528L13.3281 16.2817L13.3304 16.2842L3.90483 25.5879H11.7073L17.1227 20.3249L27.9225 31.8322C27.6855 31.94 27.4222 32 27.1448 32H1.88167C0.84245 32 0 31.1572 0 30.1176V1.88235C0 0.84276 0.842452 0 1.88167 0H27.1448C27.4434 0 27.7258 0.0695875 27.9766 0.193437Z"
                        fill="white" />
                </svg>
            </div>
            <h1>Developer Playground</h1>
            <div class="subtitle">
                Explore EximPe's payment APIs. Test integrations, manage credentials, and view real-time results.
            </div>
        </div>

        <!-- Credentials Section -->
        <div id="cred-notification"
            style="display:none; padding:12px 20px; border-radius:8px; background:#fff3cd; color:#856404; border:1px solid #ffeeba; font-size:14px; align-items:center; gap:10px;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="cred-notification-msg">Set credentials for the selected environment.</span>
            <button id="cred-notification-close"
                style="margin-left:auto; background:none; border:none; cursor:pointer; color:inherit;">&times;</button>
        </div>

        <div class="credentials-section" id="credentials-section">
            <div class="section-title-row" id="cred-toggle-btn" style="cursor: pointer; margin-bottom: 0;">
                <div class="cred-title">
                    <i class="fas fa-key"></i> API Credentials
                    <i class="fas fa-chevron-down" id="cred-chevron"
                        style="font-size: 14px; color: #94a3b8; margin-left: 8px; transition: transform 0.3s;"></i>
                </div>
                <div class="env-select-wrapper" onclick="event.stopPropagation();">
                    <span class="env-label">Environment</span>
                    <select id="env-switcher" class="env-select">
                        <option value="production">Production</option>
                        <option value="staging">Staging</option>
                        <option value="uat">UAT</option>
                        <option value="development">Development</option>
                    </select>
                </div>
            </div>

            <div id="cred-content"
                style="display: none; margin-top: 24px; border-top: 1px solid #f1f5f9; padding-top: 24px;">
                <div class="status-form">
                    <div class="form-group">
                        <label class="form-label">Client ID</label>
                        <input id="clientId" data-inject-config="CLIENT_ID" type="text" placeholder="Enter Client ID"
                            class="form-input" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Client Secret</label>
                        <input id="authKey" data-inject-config="AUTH_KEY" type="password"
                            placeholder="Enter Client Secret" class="form-input" />
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding: 10px 0;">
                            <input type="checkbox" id="isPspCheckbox"
                                style="width:18px; height:18px; accent-color: #26a887;">
                            <span class="form-label" style="margin:0;">Enable PSP Mode</span>
                        </label>
                    </div>
                    <div class="form-group" id="merchantIdGroup" style="display:none;">
                        <label class="form-label">Merchant ID</label>
                        <input id="merchantId" data-inject-config="MERCHANT_ID" type="text"
                            placeholder="Enter Merchant ID" class="form-input" />
                    </div>
                </div>

                <div class="cred-actions">
                    <button id="cred-save" class="btn btn-primary"><i class="fas fa-save"></i> Save
                        Credentials</button>
                    <button id="cred-clear" class="btn btn-secondary"><i class="fas fa-trash-alt"></i>
                        Clear</button>

                    <div style="width: 1px; height: 24px; background: #e2e8f0; margin: 0 8px;"></div>

                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input id="cred-encrypt-toggle" type="checkbox" style="accent-color: #26a887;">
                        <span style="font-size:13px; font-weight:600; color:#64748b;">Encrypt</span>
                    </label>
                    <input id="cred-passphrase" type="password" placeholder="Passphrase" class="form-input"
                        style="display:none; width: 140px;" />

                    <button id="cred-load-encrypted" class="btn btn-secondary" style="display:none;">Load</button>
                    <button id="cred-export" class="btn btn-secondary"><i class="fas fa-download"></i>
                        Export</button>
                    <button id="cred-import-btn" class="btn btn-secondary"><i class="fas fa-upload"></i>
                        Import</button>
                    <input id="cred-import-file" type="file" accept="application/json" style="display:none;" />

                    <div id="cred-status" style="margin-left:auto; color:#64748b; font-size:13px; font-weight:500;">
                    </div>
                </div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="sidebar-nav">
                <ul class="nav-menu">
                    <li><a href="#hosted-payment" class="nav-link active"><i class="fas fa-shield-alt"></i> Hosted
                            Payment</a></li>
                    <li><a href="#payment-links" class="nav-link"><i class="fas fa-link"></i> Payment Links</a></li>
                    <li><a href="#s2s-payment" class="nav-link"><i class="fas fa-server"></i> S2S Payments</a></li>
                    <li><a href="#order-management" class="nav-link"><i class="fas fa-clipboard-list"></i>
                            Orders</a></li>
                    <li><a href="#subscription-management" class="nav-link"><i class="fas fa-sync-alt"></i>
                            Subscriptions</a></li>
                    <li><a href="#refunds" class="nav-link"><i class="fas fa-undo-alt"></i> Refunds</a></li>
                    <li><a href="#settlements" class="nav-link"><i class="fas fa-money-bill-wave"></i>
                            Settlements</a></li>
                    <li><a href="#merchant-management" class="nav-link"><i class="fas fa-store"></i> Merchant</a>
                    </li>
                    <li><a href="#webhooks" class="nav-link"><i class="fas fa-bell"></i> Webhooks</a></li>
                </ul>
            </div>
            <div class="api-sections">
                <!-- EximPe Hosted Payment Section -->
                <div class="api-section" id="hosted-payment">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div>
                            <h2 class="section-title">Hosted Payment Solutions</h2>
                            <p class="section-desc">Secure, pre-built payment pages managed by EximPe.</p>
                        </div>
                    </div>
                    <div class="integrations-grid">
                        <a href="checkout/create_session.html" class="integration-card">
                            <div class="card-title">
                                <i class="fas fa-lock"></i>
                                Hosted Checkout
                            </div>
                            <div class="card-desc">
                                Redirect customers to a secure payment page. Supports UPI, Cards, Net Banking, and
                                Wallets with built-in fraud protection.
                            </div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                    </div>
                </div>

                <!-- Payment Links Section -->
                <div class="api-section" id="payment-links">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <div>
                            <h2 class="section-title">Payment Links</h2>
                            <p class="section-desc">Create and manage shareable payment links.</p>
                        </div>
                    </div>
                    <div class="integrations-grid">
                        <a href="payment_link/create_payment_link.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-plus-circle"></i> Create Link</div>
                            <div class="card-desc">Generate links for UPI, Cards, and more. Set expiry and track
                                status.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="payment_link/retrieve_payment_link.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-search"></i> Retrieve Link</div>
                            <div class="card-desc">Fetch details like status, buyer info, and settlement data.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="payment_link/list_payment_links.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-list"></i> List Links</div>
                            <div class="card-desc">View all payment links with filtering options.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="payment_link/deactivate_payment_link.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-ban"></i> Deactivate Link</div>
                            <div class="card-desc">Cancel active links to prevent further payments.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="payment_link/share_payment_link.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-share-alt"></i> Share Link</div>
                            <div class="card-desc">Send links via Email or SMS directly to customers.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="payment_link/extend_payment_link_expiry.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-calendar-plus"></i> Extend Expiry</div>
                            <div class="card-desc">Update the validity period of an active link.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="payment_link/upload_documents.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-file-upload"></i> Upload Docs</div>
                            <div class="card-desc">Submit Invoices or AWBs for compliance.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                    </div>
                </div>

                <!-- S2S Section -->
                <div class="api-section" id="s2s-payment">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-server"></i>
                        </div>
                        <div>
                            <h2 class="section-title">Server-to-Server (S2S)</h2>
                            <p class="section-desc">Direct backend integration for complete control.</p>
                        </div>
                    </div>
                    <div class="integrations-grid">
                        <a href="s2s/upi_intent.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-mobile-alt"></i> UPI Intent</div>
                            <div class="card-desc">Deep-link directly to UPI apps like GPay and PhonePe.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="s2s/upi_collection.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-qrcode"></i> UPI Collection</div>
                            <div class="card-desc">Collect payments via Dynamic QR or UPI ID push.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="s2s/vpa_validation.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-check-circle"></i> VPA Validation</div>
                            <div class="card-desc">Verify UPI IDs before initiating transactions.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="s2s/card_payment.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-credit-card"></i> Card Payment</div>
                            <div class="card-desc">Process Credit/Debit cards with 3D Secure.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="s2s/qr_payment.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-qrcode"></i> QR Payment</div>
                            <div class="card-desc">Generate QR codes for instant scanning.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                    </div>
                </div>

                <!-- Order Management Section -->
                <div class="api-section" id="order-management">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div>
                            <h2 class="section-title">Order Management</h2>
                            <p class="section-desc">Track and manage your orders.</p>
                        </div>
                    </div>
                    <div class="integrations-grid">
                        <a href="order/order_details.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-info-circle"></i> Order Details</div>
                            <div class="card-desc">Get full order info, status, and timeline.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="order/edit_order.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-edit"></i> Edit Order</div>
                            <div class="card-desc">Update shipping info and invoice details.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="order/order_verification.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-shield-check"></i> Verify Order</div>
                            <div class="card-desc">Upload proof of delivery for verification.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                    </div>
                </div>

                <!-- Subscription Management Section -->
                <div class="api-section" id="subscription-management">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div>
                            <h2 class="section-title">Subscriptions</h2>
                            <p class="section-desc">Handle recurring billing and plans.</p>
                        </div>
                    </div>
                    <div class="integrations-grid">
                        <a href="subscription/subscriptions.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-calendar-check"></i> Create Subscription</div>
                            <div class="card-desc">Set up recurring payments with auto-debit.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="subscription/subscription_management.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-tasks"></i> Manage Plans</div>
                            <div class="card-desc">Look up and modify existing subscriptions.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                    </div>
                </div>

                <!-- Refund Section -->
                <div class="api-section" id="refunds">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-undo-alt"></i>
                        </div>
                        <div>
                            <h2 class="section-title">Refunds</h2>
                            <p class="section-desc">Process and track transaction refunds.</p>
                        </div>
                    </div>
                    <div class="integrations-grid">
                        <a href="refund/refund.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-undo"></i> Initiate Refund</div>
                            <div class="card-desc">Process full or partial refunds instantly.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="refund/refund_details.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-search"></i> Refund Status</div>
                            <div class="card-desc">Check the status of processed refunds.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                    </div>
                </div>

                <!-- Settlement Section -->
                <div class="api-section" id="settlements">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div>
                            <h2 class="section-title">Settlements</h2>
                            <p class="section-desc">View settlement reports and details.</p>
                        </div>
                    </div>
                    <div class="integrations-grid">
                        <a href="settlements/settlements.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-university"></i> All Settlements</div>
                            <div class="card-desc">Comprehensive reports with fees and taxes.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="settlements/payment_settlements.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-money-check-alt"></i> Payment Settlements</div>
                            <div class="card-desc">Track settlements for specific payments.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="settlements/refund_settlements.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-receipt"></i> Refund Settlements</div>
                            <div class="card-desc">Reconcile refund deductions and adjustments.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                    </div>
                </div>

                <!-- Merchant Management Section -->
                <div class="api-section" id="merchant-management">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-store"></i>
                        </div>
                        <div>
                            <h2 class="section-title">Merchant Management</h2>
                            <p class="section-desc">Onboard and manage merchant accounts.</p>
                        </div>
                    </div>
                    <div class="integrations-grid">
                        <a href="merchant/create_merchant.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-plus-circle"></i> Add Merchant</div>
                            <div class="card-desc">Onboard new merchants with KYC and banking info.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                        <a href="merchant/merchant_details.html" class="integration-card">
                            <div class="card-title"><i class="fas fa-user-tie"></i> View Merchant</div>
                            <div class="card-desc">Check profile, limits, and fees.</div>
                            <div class="card-footer">Try Now <i class="fas fa-arrow-right"></i></div>
                        </a>
                    </div>
                </div>

                <!-- Webhooks Section -->
                <div class="api-section" id="webhooks">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div>
                            <h2 class="section-title">Webhooks</h2>
                            <p class="section-desc">Real-time event notifications.</p>
                        </div>
                    </div>
                    <div class="integrations-grid">
                        <a href="#" class="integration-card" style="cursor: default;">
                            <div class="badge-soon">Coming Soon</div>
                            <div class="card-title"><i class="fas fa-bell"></i> Events</div>
                            <div class="card-desc">Listen for payment, refund, and settlement events.</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pass Django variables to JavaScript -->
    <script>
        window.API_URL = (window.Config && window.Config.API_URL) || '';

        // --- Web Crypto helpers for AES-GCM encryption using a passphrase ---
        async function deriveKey(passphrase, salt) {
            const enc = new TextEncoder();
            const passKey = await window.crypto.subtle.importKey('raw', enc.encode(passphrase), 'PBKDF2', false, ['deriveKey']);
            return window.crypto.subtle.deriveKey({
                name: 'PBKDF2',
                salt: salt,
                iterations: 250000,
                hash: 'SHA-256'
            }, passKey, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']);
        }

        function concatBuffers(...bufs) {
            let total = 0;
            bufs.forEach(b => total += b.byteLength);
            const tmp = new Uint8Array(total);
            let offset = 0;
            bufs.forEach(b => { tmp.set(new Uint8Array(b), offset); offset += b.byteLength; });
            return tmp.buffer;
        }

        function toBase64(buf) { return btoa(String.fromCharCode(...new Uint8Array(buf))); }
        function fromBase64(str) { return Uint8Array.from(atob(str), c => c.charCodeAt(0)).buffer; }

        async function encryptString(plaintext, passphrase) {
            const enc = new TextEncoder();
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const key = await deriveKey(passphrase, salt.buffer);
            const ct = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, enc.encode(plaintext));
            // store as base64(salt|iv|ciphertext)
            return toBase64(concatBuffers(salt.buffer, iv.buffer, ct));
        }

        async function decryptString(b64payload, passphrase) {
            try {
                const raw = fromBase64(b64payload);
                const full = new Uint8Array(raw);
                const salt = full.slice(0, 16).buffer;
                const iv = full.slice(16, 28).buffer;
                const ct = full.slice(28).buffer;
                const key = await deriveKey(passphrase, salt);
                const pt = await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, key, ct);
                return new TextDecoder().decode(pt);
            } catch (e) {
                throw new Error('Decryption failed');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const envSwitcher = document.getElementById('env-switcher');
            const statusEl = document.getElementById('cred-status');
            const encryptToggle = document.getElementById('cred-encrypt-toggle');
            const passInput = document.getElementById('cred-passphrase');
            const importFile = document.getElementById('cred-import-file');

            function getSelectedEnv() {
                return localStorage.getItem('selected_env') || (window.Config && window.Config.CURRENT_ENV) || (envSwitcher && envSwitcher.value) || 'production';
            }

            // Check if credentials exist for the selected environment
            function credentialsExistForEnv() {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                const raw = localStorage.getItem(storedKey);
                if (!raw) return false;
                // If encrypted, require passphrase to load, so treat as not set
                try {
                    const parsed = JSON.parse(raw);
                    // Must have at least CLIENT_ID and AUTH_KEY
                    return Boolean(parsed.CLIENT_ID && parsed.AUTH_KEY);
                } catch (e) {
                    // Encrypted or malformed, treat as not set
                    return false;
                }
            }

            // Determine if a stored entry is encrypted by checking if value is a string that doesn't parse as JSON
            function isEncryptedString(val) {
                if (typeof val !== 'string') return false;
                try { JSON.parse(val); return false; } catch (_) { return true; }
            }

            function loadCredentials() {
                const env = getSelectedEnv();
                if (envSwitcher) envSwitcher.value = env;
                const storedKey = 'eximpe_credentials_' + env;
                let raw = localStorage.getItem(storedKey);
                if (!raw) {
                    // fall back to window.Config values
                    document.getElementById('clientId').value = (window.Config && (window.Config.CLIENT_ID || window.Config.CLIENTID || window.Config.CLIENT)) || (window.Config && window.Config.CLIENT_ID) || '';
                    document.getElementById('authKey').value = (window.Config && (window.Config.AUTH_KEY || window.Config.CLIENT_SECRET || window.Config.AUTH_KEY)) || '';
                    document.getElementById('merchantId').value = (window.Config && window.Config.MERCHANT_ID) || '';
                    document.getElementById('isPspCheckbox').checked = false;
                    const _cbEl = document.getElementById('cred-callback-url');
                    if (_cbEl) _cbEl.value = (window.Config && window.Config.CALLBACK_URL) || '';
                    statusEl.textContent = 'No credentials for ' + env;
                    return;
                }

                if (isEncryptedString(raw)) {
                    statusEl.textContent = 'Encrypted credentials found — enter passphrase and click Load';
                    // leave fields alone until decrypted
                    document.getElementById('clientId').value = '';
                    document.getElementById('authKey').value = '';
                    document.getElementById('merchantId').value = '';
                    document.getElementById('isPspCheckbox').checked = false;
                    const _cbEl2 = document.getElementById('cred-callback-url');
                    if (_cbEl2) _cbEl2.value = '';
                } else {
                    try {
                        const parsed = JSON.parse(raw || '{}');
                        document.getElementById('clientId').value = parsed.CLIENT_ID || parsed.API_KEY || '';
                        document.getElementById('authKey').value = parsed.AUTH_KEY || parsed.MERCHANT_SECRET || '';
                        document.getElementById('merchantId').value = parsed.MERCHANT_ID || '';
                        document.getElementById('isPspCheckbox').checked = parsed.IS_PSP ? true : false;
                        const _cbEl3 = document.getElementById('cred-callback-url');
                        if (_cbEl3) _cbEl3.value = parsed.CALLBACK_URL || '';
                        statusEl.textContent = 'Loaded credentials for ' + env;
                    } catch (e) {
                        statusEl.textContent = 'Failed to parse stored credentials for ' + env;
                    }
                }
                // toggle merchant id visibility like other pages expect
                const merchantGroup = document.getElementById('merchantIdGroup');
                if (merchantGroup) merchantGroup.style.display = document.getElementById('isPspCheckbox').checked ? 'block' : 'none';
            }

            async function saveCredentials() {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                const payload = {
                    CLIENT_ID: document.getElementById('clientId').value || '',
                    AUTH_KEY: document.getElementById('authKey').value || '',
                    IS_PSP: document.getElementById('isPspCheckbox').checked ? true : false,
                    MERCHANT_ID: document.getElementById('merchantId').value || '',
                    CALLBACK_URL: (document.getElementById('cred-callback-url') ? document.getElementById('cred-callback-url').value : '') || ''
                };

                if (encryptToggle.checked) {
                    const pass = passInput.value || '';
                    if (!pass) { statusEl.textContent = 'Enter passphrase to encrypt'; return; }
                    try {
                        const enc = await encryptString(JSON.stringify(payload), pass);
                        localStorage.setItem(storedKey, enc);
                        statusEl.textContent = 'Saved (encrypted) credentials for ' + env;
                    } catch (e) {
                        statusEl.textContent = 'Encryption failed';
                    }
                } else {
                    localStorage.setItem(storedKey, JSON.stringify(payload));
                    statusEl.textContent = 'Saved credentials for ' + env;
                }
            }

            async function loadEncryptedWithPassphrase() {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                const raw = localStorage.getItem(storedKey);
                if (!raw || !isEncryptedString(raw)) { statusEl.textContent = 'No encrypted credentials to load'; return; }
                const pass = passInput.value || '';
                if (!pass) { statusEl.textContent = 'Enter passphrase to decrypt'; return; }
                try {
                    const dec = await decryptString(raw, pass);
                    const parsed = JSON.parse(dec || '{}');
                    document.getElementById('clientId').value = parsed.CLIENT_ID || '';
                    document.getElementById('authKey').value = parsed.AUTH_KEY || '';
                    document.getElementById('merchantId').value = parsed.MERCHANT_ID || '';
                    document.getElementById('isPspCheckbox').checked = parsed.IS_PSP ? true : false;
                    const _cbEl4 = document.getElementById('cred-callback-url');
                    if (_cbEl4) _cbEl4.value = parsed.CALLBACK_URL || '';
                    statusEl.textContent = 'Decrypted and loaded for ' + env;
                } catch (e) {
                    statusEl.textContent = 'Decryption failed — bad passphrase?';
                }
            }

            function clearCredentials() {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                localStorage.removeItem(storedKey);
                loadCredentials();
                statusEl.textContent = 'Cleared credentials for ' + env;
            }

            async function exportCredentials() {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                const raw = localStorage.getItem(storedKey);
                if (!raw) { statusEl.textContent = 'No credentials to export for ' + env; return; }
                const blob = new Blob([raw], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `eximpe_credentials_${env}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                statusEl.textContent = 'Exported credentials for ' + env;
            }

            function importCredentialsFile(file) {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                const reader = new FileReader();
                reader.onload = function (e) {
                    const text = e.target.result;
                    // store as-is (could be encrypted or plain JSON)
                    localStorage.setItem(storedKey, text);
                    loadCredentials();
                    statusEl.textContent = 'Imported credentials for ' + env;
                };
                reader.readAsText(file);
            }

            if (envSwitcher) {
                envSwitcher.value = getSelectedEnv();
                envSwitcher.addEventListener('change', (e) => {
                    const newEnv = e.target.value;
                    localStorage.setItem('selected_env', newEnv);
                    loadCredentials();
                });
            }

            encryptToggle.addEventListener('change', () => {
                passInput.style.display = encryptToggle.checked ? 'inline-block' : 'none';
            });

            // Handle PSP checkbox toggling of merchant ID field
            const isPspCb = document.getElementById('isPspCheckbox');
            if (isPspCb) {
                isPspCb.addEventListener('change', () => {
                    const merchantGroup = document.getElementById('merchantIdGroup');
                    if (merchantGroup) merchantGroup.style.display = isPspCb.checked ? 'block' : 'none';
                });
            }

            document.getElementById('cred-save').addEventListener('click', saveCredentials);
            document.getElementById('cred-clear').addEventListener('click', clearCredentials);
            document.getElementById('cred-export').addEventListener('click', exportCredentials);
            document.getElementById('cred-import-btn').addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) importCredentialsFile(e.target.files[0]); });

            // Wire up the Load Encrypted button in the UI
            const loadEncryptedBtn = document.getElementById('cred-load-encrypted');
            if (loadEncryptedBtn) loadEncryptedBtn.addEventListener('click', loadEncryptedWithPassphrase);

            // Prevent navigation if credentials are not set
            function showCredNotification(msg) {
                const notif = document.getElementById('cred-notification');
                const notifMsg = document.getElementById('cred-notification-msg');
                if (notif && notifMsg) {
                    notifMsg.textContent = msg;
                    notif.style.display = 'flex';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    // Auto-hide after 4 seconds
                    if (notif._timeout) clearTimeout(notif._timeout);
                    notif._timeout = setTimeout(() => { notif.style.display = 'none'; }, 4000);
                }
            }

            function blockIntegrationNavigationIfNoCreds() {
                const integrationLinks = document.querySelectorAll('.integration-card[href]:not([href=""])');
                integrationLinks.forEach(link => {
                    link.addEventListener('click', function (e) {
                        if (!credentialsExistForEnv()) {
                            e.preventDefault();
                            showCredNotification('Set credentials for the selected environment before proceeding.');
                        }
                    });
                });
                // Dismiss button
                const notifClose = document.getElementById('cred-notification-close');
                if (notifClose) {
                    notifClose.addEventListener('click', function () {
                        const notif = document.getElementById('cred-notification');
                        if (notif) notif.style.display = 'none';
                    });
                }
            }

            // initial load
            loadCredentials();
            blockIntegrationNavigationIfNoCreds();

            // Scroll Spy for Sidebar
            const sections = document.querySelectorAll('.api-section');
            const navLinks = document.querySelectorAll('.sidebar-nav a');

            function onScroll() {
                let current = '';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (scrollY >= sectionTop - 100) {
                        current = section.getAttribute('id');
                    }
                });

                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href').includes(current)) {
                        link.classList.add('active');
                    }
                });
            }

            window.addEventListener('scroll', onScroll);

            // Credentials Toggle Logic
            const credToggleBtn = document.getElementById('cred-toggle-btn');
            const credContent = document.getElementById('cred-content');
            const credChevron = document.getElementById('cred-chevron');
            let isCredExpanded = false;

            function toggleCredentials() {
                isCredExpanded = !isCredExpanded;
                credContent.style.display = isCredExpanded ? 'block' : 'none';
                credChevron.style.transform = isCredExpanded ? 'rotate(180deg)' : 'rotate(0deg)';

                // Update margin of title row
                const titleRow = document.querySelector('.section-title-row');
                if (titleRow) {
                    titleRow.style.marginBottom = isCredExpanded ? '0' : '0';
                }
            }

            if (credToggleBtn) {
                credToggleBtn.addEventListener('click', toggleCredentials);
            }

            // Auto-expand if no credentials
            if (!credentialsExistForEnv()) {
                toggleCredentials();
            }

            // Mobile Navigation Logic
            const mobileNavToggle = document.getElementById('mobile-nav-toggle');
            const sidebarNav = document.querySelector('.sidebar-nav');

            if (mobileNavToggle && sidebarNav) {
                mobileNavToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebarNav.classList.toggle('active');
                    const icon = mobileNavToggle.querySelector('i');
                    if (sidebarNav.classList.contains('active')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });

                // Close sidebar when clicking outside
                document.addEventListener('click', (e) => {
                    if (sidebarNav.classList.contains('active') &&
                        !sidebarNav.contains(e.target) &&
                        !mobileNavToggle.contains(e.target)) {
                        sidebarNav.classList.remove('active');
                        const icon = mobileNavToggle.querySelector('i');
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });

                // Close sidebar when clicking a link
                const navLinks = sidebarNav.querySelectorAll('a');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        sidebarNav.classList.remove('active');
                        const icon = mobileNavToggle.querySelector('i');
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    });
                });
            }
        });
    </script>

    <!-- Mobile Nav Toggle Button -->
    <button class="mobile-nav-toggle" id="mobile-nav-toggle">
        <i class="fas fa-bars"></i>
    </button>
</body>

</html>