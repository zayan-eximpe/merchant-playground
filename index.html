<!DOCTYPE html>
<html lang="en">

<head>
    <script src="assets/js/config.js?v=1.0.2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="https://eximpe.com/EximPe.webp">
    <title>EximPe Integrations</title>

    <link rel="stylesheet" href="assets/css/fontawesome-all.min.css?v=1.0.2">
    <link rel="stylesheet" href="assets/css/index.css?v=1.0.2">
</head>

<body>
    <div class="container">
        <div class="logo-circle">
            <svg width="38" height="38" viewBox="0 0 28 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M27.9766 0.193437L17.3616 11.8518L11.7609 6.4086H3.9584L13.6276 15.9528L13.3281 16.2817L13.3304 16.2842L3.90483 25.5879H11.7073L17.1227 20.3249L27.9225 31.8322C27.6855 31.94 27.4222 32 27.1448 32H1.88167C0.84245 32 0 31.1572 0 30.1176V1.88235C0 0.84276 0.842452 0 1.88167 0H27.1448C27.4434 0 27.7258 0.0695875 27.9766 0.193437Z"
                    fill="white" />
            </svg>
        </div>
        <h1 style="color: rgb(38, 168, 135);">EximPe Integrations</h1>
        <div class="subtitle">
            Select an integration below to explore and test its features.
        </div>

        <div class="description-section"
            style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 24px; border: 1px solid #e2e8f0;">
            <h3
                style="color: #2d3748; font-size: 18px; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-info-circle" style="color: rgb(38, 168, 135);"></i>
                About EximPe Integrations
            </h3>
            <p style="color: #4a5568; font-size: 14px; line-height: 1.6; margin: 0;">
                Welcome to EximPe's Integration Platform. This comprehensive suite of APIs enables you to seamlessly
                integrate payment processing, order management, refund handling, and settlement tracking into your
                applications. Our platform provides secure, reliable, and scalable solutions for businesses of all
                sizes. Each integration is designed with developer-friendly documentation and testing tools to ensure
                smooth implementation.
            </p>
        </div>

        <div class="header-actions">
            <a href="https://docs.eximpe.com" target="_blank" rel="noopener" class="header-button">
                <i class="fas fa-book"></i>
                Integration Docs
            </a>
            <a href="https://merchant.eximpe.com" target="_blank" rel="noopener" class="header-button">
                <i class="fas fa-chart-line"></i>
                Dashboard
            </a>
        </div>

        <!-- Credentials per-environment -->
        <!-- Notification for missing credentials -->
        <div id="cred-notification"
            style="display:none; margin-bottom:16px; padding:12px 20px; border-radius:8px; background:#fff3cd; color:#856404; border:1px solid #ffeeba; font-size:15px; position:relative; align-items:center; gap:10px;">
            <span style="display:inline-flex; align-items:center; gap:8px;"><i class="fas fa-exclamation-triangle"></i>
                <span id="cred-notification-msg">Set credentials for the selected environment before
                    proceeding.</span></span>
            <button id="cred-notification-close"
                style="position:absolute; right:12px; top:10px; background:none; border:none; color:#856404; font-size:18px; cursor:pointer;">&times;</button>
        </div>
        <div class="form-section" id="credentials-section"
            style="background: #f8fafc; border-radius: 12px; padding: 28px 24px 20px 24px; margin-bottom: 32px; border: 2px solid #38a887; box-shadow: 0 2px 8px 0 rgba(38,168,135,0.06);">

            <div
                style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:16px 8px; margin-bottom:10px;">
                <div class="section-title" style="margin:0; padding:0;"><i class="fas fa-key"></i> Credentials
                    (per-environment)</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <label for="env-switcher"
                        style="font-size:14px; color:#2d3748; font-weight:500;">Environment:</label>
                    <select id="env-switcher" class="header-button"
                        style="cursor:pointer; outline:none; background-color:white; border:1.5px solid #38a887; border-radius:6px; padding:6px 18px; font-size:15px; color:#2d3748; font-weight:500;">
                        <option value="production">Production</option>
                        <option value="staging">Staging</option>
                        <option value="uat">UAT</option>
                        <option value="development">Development</option>
                    </select>
                </div>
            </div>

            <div class="status-form"
                style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:18px 20px; margin-top:18px; margin-bottom:10px;">
                <div class="form-group">
                    <label class="form-label">Client ID</label>
                    <input id="clientId" data-inject-config="CLIENT_ID" type="text" placeholder="Enter Client ID"
                        class="form-input" />
                </div>
                <div class="form-group">
                    <label class="form-label">Client Secret</label>
                    <input id="authKey" data-inject-config="AUTH_KEY" type="password" placeholder="Enter Client Secret"
                        class="form-input" />
                </div>
                <!-- Callback URL not required in playground credentials panel -->
                <div class="form-group tooltip" style="display:flex; align-items:center;">
                    <label class="form-label" style="margin:0 12px 0 0;">PSP Mode</label>
                    <label style="display:flex; align-items:center; gap:8px; margin:0; cursor:pointer;">
                        <input type="checkbox" id="isPspCheckbox"
                            style="width:18px; height:18px; margin:0; cursor:pointer; accent-color: rgb(38, 168, 135);">
                        <span style="font-weight:normal; color:#4a5568;">Is PSP?</span>
                    </label>
                </div>
                <div class="form-group" id="merchantIdGroup" style="display:none;">
                    <label class="form-label">Merchant ID</label>
                    <input id="merchantId" data-inject-config="MERCHANT_ID" type="text" placeholder="Enter Merchant ID"
                        class="form-input" />
                </div>
                <div class="form-group">
                    <label class="form-label">Asset Version</label>
                    <input id="assetVersion" data-inject-config="VERSION" type="text" placeholder="e.g. 1.0.1"
                        class="form-input" />
                </div>
            </div>

            <div style="margin-top:18px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                <button id="cred-save" class="status-button small-btn">Save Credentials</button>
                <button id="cred-clear" class="secondary-button small-btn">Clear Credentials</button>

                <label style="display:flex; align-items:center; gap:8px;">
                    <input id="cred-encrypt-toggle" type="checkbox" /> <span
                        style="font-size:13px; color:#4a5568;">Encrypt</span>
                </label>
                <input id="cred-passphrase" type="password" placeholder="Passphrase (for encryption)" class="form-input"
                    style="display:none; min-width:220px;" />

                <button id="cred-export" class="secondary-button small-btn">Export</button>
                <button id="cred-import-btn" class="secondary-button small-btn">Import</button>
                <input id="cred-import-file" type="file" accept="application/json" style="display:none;" />

                <button id="cred-load-encrypted" class="status-button small-btn">Load Encrypted</button>

                <div id="cred-status" style="align-self:center; color:#4a5568; font-size:13px;"></div>
            </div>
        </div>

        <div class="api-sections">
            <!-- EximPe Hosted Payment Section -->
            <div class="api-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>
                        <h2 class="section-title">EximPe Hosted Payment Solutions</h2>
                        <div class="section-description">Secure, hosted payment processing managed by EximPe</div>
                    </div>
                </div>
                <div class="integrations-grid">
                    <a href="checkout/create_session.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-lock"></i>
                            Hosted Payment Page
                        </div>
                        <div class="integration-description">
                            Redirect customers to EximPe's secure payment gateway. Supports UPI, cards, net banking, and
                            wallets. Zero PCI compliance burden on your side with built-in fraud protection and 3D
                            Secure authentication.
                        </div>
                    </a>
                </div>
            </div>

            <!-- Payment Links Section -->
            <div class="api-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Payment Links APIs</h2>
                        <div class="section-description">Create, manage, and track payment links for seamless payment
                            collection</div>
                    </div>
                </div>
                <div class="integrations-grid">
                    <a href="payment_link/create_payment_link.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-plus-circle"></i>
                            Create Payment Link
                        </div>
                        <div class="integration-description">
                            Generate shareable payment links for customers to complete their payment. Supports UPI,
                            cards, net
                            banking, and wallets. Set custom expiry dates, add buyer and product details, and track
                            payment status in real-time.
                        </div>
                    </a>
                    <a href="payment_link/retrieve_payment_link.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-search"></i>
                            Retrieve Payment Link
                        </div>
                        <div class="integration-description">
                            Fetch detailed information about a specific payment link including payment status, buyer
                            details, settlement information, and transaction metadata. Essential for order tracking and
                            customer support.
                        </div>
                    </a>
                    <a href="payment_link/list_payment_links.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-list"></i>
                            List Payment Links
                        </div>
                        <div class="integration-description">
                            Get a paginated list of all payment links created by your merchant account. Filter by
                            status, date range, and other parameters to manage your payment links efficiently.
                        </div>
                    </a>
                    <a href="payment_link/deactivate_payment_link.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-ban"></i>
                            Deactivate Payment Link
                        </div>
                        <div class="integration-description">
                            Deactivate an active payment link to prevent further payments. Useful for canceling orders,
                            handling expired requests, or managing payment link lifecycle.
                        </div>
                    </a>
                    <a href="payment_link/share_payment_link.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-share-alt"></i>
                            Share Payment Link
                        </div>
                        <div class="integration-description">
                            Send payment links directly to customers via email or SMS. Supports multiple recipients and
                            automatic notification delivery with customizable messaging.
                        </div>
                    </a>
                    <a href="payment_link/extend_payment_link_expiry.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-calendar-plus"></i>
                            Extend Expiry
                        </div>
                        <div class="integration-description">
                            Extend the validity of an active payment link by setting a new expiry date. Useful for
                            giving customers more time to complete their payments without creating a new link.
                        </div>
                    </a>
                    <a href="payment_link/upload_documents.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-file-upload"></i>
                            Upload Documents
                        </div>
                        <div class="integration-description">
                            Upload required Invoice or Air Waybill (AWB) documents for a payment link. Essential for
                            meeting regulatory requirements and ensuring smooth settlement processing.
                        </div>
                    </a>
                </div>
            </div>

            <!-- S2S Section -->
            <div class="api-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-server"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Server-to-Server (S2S) Payment APIs</h2>
                        <div class="section-description">Direct backend payment processing with complete control over
                            the payment flow</div>
                    </div>
                </div>
                <div class="integrations-grid">
                    <a href="s2s/upi_intent.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-exchange-alt"></i>
                            S2S UPI Intent
                        </div>
                        <div class="integration-description">
                            Generate UPI Intent URLs that open UPI apps directly (GPay, PhonePe, Paytm). Best for mobile
                            apps and websites targeting UPI-savvy users. Faster checkout with seamless app-to-app
                            payments.
                        </div>
                    </a>
                    <a href="s2s/upi_collection.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-code"></i>
                            S2S UPI Collection
                        </div>
                        <div class="integration-description">
                            Collect UPI payments by displaying QR codes or UPI IDs on your interface. Customers scan QR
                            or enter UPI ID manually. Ideal for web platforms and kiosk payments with real-time status
                            updates.
                        </div>
                    </a>
                    <a href="s2s/vpa_validation.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-search"></i>
                            VPA Validation
                        </div>
                        <div class="integration-description">
                            Validate UPI Virtual Payment Addresses (VPA) before processing payments. Check if a VPA is
                            active and ready for transactions. Essential for preventing failed payments and improving
                            user experience.
                        </div>
                    </a>
                    <a href="s2s/card_payment.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-credit-card"></i>
                            S2S Card Payment
                        </div>
                        <div class="integration-description">
                            Process card payments directly through server-to-server integration. Supports credit and
                            debit cards with 3D Secure authentication. Complete control over payment flow with enhanced
                            security and fraud protection.
                        </div>
                    </a>
                    <a href="s2s/qr_payment.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-exchange-alt"></i>
                            S2S QR Payment
                        </div>
                        <div class="integration-description">
                            Generate QR codes for QR payment. Best for mobile apps and websites targeting QR-savvy
                            users. Faster checkout with seamless app-to-app payments.
                        </div>
                    </a>
                </div>
            </div>

            <!-- Order Management Section -->
            <div class="api-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Order Management APIs</h2>
                        <div class="section-description">Comprehensive order management and tracking</div>
                    </div>
                </div>
                <div class="integrations-grid">
                    <a href="order/order_details.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-info-circle"></i>
                            Order Details
                        </div>
                        <div class="integration-description">
                            Retrieve comprehensive order information including payment status, customer details,
                            transaction timeline, and settlement data. Essential for order tracking and customer support
                            operations.
                        </div>
                    </a>
                    <a href="order/edit_order.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-edit"></i>
                            Edit Order
                        </div>
                        <div class="integration-description">
                            Update order information with shipping details, invoice data, and compliance documents
                            required for settlement processing. Helps expedite fund disbursement and regulatory
                            compliance.
                        </div>
                    </a>
                    <a href="order/order_verification.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-shield-check"></i>
                            Upload Invoice/AWB
                        </div>
                        <div class="integration-description">
                            Submit proof of delivery, shipping confirmations, and compliance documents to verify
                            legitimate transactions. Reduces chargeback risk and ensures faster settlement approval.
                        </div>
                    </a>
                </div>
            </div>

            <!-- Subscription Management Section -->
            <div class="api-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Subscription Management APIs</h2>
                        <div class="section-description">Manage recurring subscriptions and billing cycles</div>
                    </div>
                </div>
                <div class="integrations-grid">
                    <a href="subscription/subscriptions.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-calendar-check"></i>
                            Subscriptions
                        </div>
                        <div class="integration-description">
                            Create, manage, and track recurring subscriptions with automated billing cycles. Handle
                            subscription lifecycle events including activation, renewal, cancellation, and payment
                            failures.
                        </div>
                    </a>
                    <a href="subscription/subscription_management.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-sync"></i>
                            Subscription Management
                        </div>
                        <div class="integration-description">
                            Look up existing subscriptions by Subscription ID using the Partner API subscription details
                            endpoint.
                        </div>
                    </a>
                </div>
            </div>

            <!-- Refund Section -->
            <div class="api-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-undo-alt"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Refund APIs</h2>
                        <div class="section-description">Manage refunds and track refund status for transactions</div>
                    </div>
                </div>
                <div class="integrations-grid">
                    <a href="refund/refund.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-undo"></i>
                            Refund Transaction
                        </div>
                        <div class="integration-description">
                            Initiate full or partial refunds for successful payments. Supports instant UPI refunds and
                            card refunds with real-time status tracking. Automatic webhook notifications for refund
                            status updates.
                        </div>
                    </a>

                    <a href="refund/refund_details.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-search"></i>
                            Refund Details
                        </div>
                        <div class="integration-description">
                            Query refund status with complete transaction details including bank reference numbers,
                            processing timeline, and failure reasons. Essential for refund reconciliation and customer
                            inquiries.
                        </div>
                    </a>
                </div>
            </div>

            <!-- Settlement Section -->
            <div class="api-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Settlement APIs</h2>
                        <div class="section-description">Manage and track your payment settlements</div>
                    </div>
                </div>
                <div class="integrations-grid">
                    <a href="settlements/settlements.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-university"></i>
                            Settlements
                        </div>
                        <div class="integration-description">
                            Access comprehensive settlement reports with transaction-level breakdowns, fee calculations,
                            and disbursement schedules. Includes tax deductions and regulatory compliance data.
                        </div>
                    </a>

                    <a href="settlements/payment_settlements.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-money-check-alt"></i>
                            Payment Settlements
                        </div>
                        <div class="integration-description">
                            Track payment-specific settlement data including successful transaction amounts, merchant
                            fees, and net settlement values. Real-time updates on settlement status and bank transfer
                            details.
                        </div>
                    </a>
                    <a href="settlements/refund_settlements.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-receipt"></i>
                            Refund Settlements
                        </div>
                        <div class="integration-description">
                            Monitor refund settlement reconciliation including deducted amounts from merchant
                            settlements, refund processing fees, and net adjustment calculations. Essential for
                            financial reconciliation.
                        </div>
                    </a>
                </div>
            </div>

            <!-- Merchant Management Section -->
            <div class="api-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-store"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Merchant Management APIs</h2>
                        <div class="section-description">Comprehensive merchant account management</div>
                    </div>
                </div>
                <div class="integrations-grid">
                    <a href="merchant/create_merchant.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-plus-circle"></i>
                            Add Merchant
                        </div>
                        <div class="integration-description">
                            Onboard new merchants with comprehensive business details, KYC documents, banking
                            information, and payment method configurations. Automated compliance checks and instant
                            merchant ID generation.
                        </div>
                    </a>

                    <a href="merchant/merchant_details.html" class="integration-card">
                        <div class="integration-title">
                            <i class="fas fa-user-tie"></i>
                            View Merchant
                        </div>
                        <div class="integration-description">
                            Access complete merchant profile including verification status, transaction limits, fee
                            structures, and settlement configurations. Update merchant settings and view approval
                            workflows.
                        </div>
                    </a>
                </div>
            </div>

            <!-- Webhooks Section -->
            <div class="api-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Webhooks</h2>
                        <div class="section-description">Real-time event notifications for payments and merchant
                            activities</div>
                    </div>
                </div>
                <div class="integrations-grid">
                    <a href="" class="integration-card">
                        <div class="coming-soon-badge">
                            <i class="fas fa-clock"></i>
                            Coming Soon
                        </div>
                        <div class="integration-title">
                            <i class="fas fa-bell-concierge"></i>
                            Payment/Merchant Webhooks
                        </div>
                        <div class="integration-description">
                            Receive real-time notifications for payment status changes, refund updates, settlement
                            events, and merchant verification milestones. Secure webhook endpoints with signature
                            verification and retry mechanisms.
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Pass Django variables to JavaScript -->
    <script>
        window.API_URL = (window.Config && window.Config.API_URL) || '';

        // --- Web Crypto helpers for AES-GCM encryption using a passphrase ---
        async function deriveKey(passphrase, salt) {
            const enc = new TextEncoder();
            const passKey = await window.crypto.subtle.importKey('raw', enc.encode(passphrase), 'PBKDF2', false, ['deriveKey']);
            return window.crypto.subtle.deriveKey({
                name: 'PBKDF2',
                salt: salt,
                iterations: 250000,
                hash: 'SHA-256'
            }, passKey, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']);
        }

        function concatBuffers(...bufs) {
            let total = 0;
            bufs.forEach(b => total += b.byteLength);
            const tmp = new Uint8Array(total);
            let offset = 0;
            bufs.forEach(b => { tmp.set(new Uint8Array(b), offset); offset += b.byteLength; });
            return tmp.buffer;
        }

        function toBase64(buf) { return btoa(String.fromCharCode(...new Uint8Array(buf))); }
        function fromBase64(str) { return Uint8Array.from(atob(str), c => c.charCodeAt(0)).buffer; }

        async function encryptString(plaintext, passphrase) {
            const enc = new TextEncoder();
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const key = await deriveKey(passphrase, salt.buffer);
            const ct = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, enc.encode(plaintext));
            // store as base64(salt|iv|ciphertext)
            return toBase64(concatBuffers(salt.buffer, iv.buffer, ct));
        }

        async function decryptString(b64payload, passphrase) {
            try {
                const raw = fromBase64(b64payload);
                const full = new Uint8Array(raw);
                const salt = full.slice(0, 16).buffer;
                const iv = full.slice(16, 28).buffer;
                const ct = full.slice(28).buffer;
                const key = await deriveKey(passphrase, salt);
                const pt = await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, key, ct);
                return new TextDecoder().decode(pt);
            } catch (e) {
                throw new Error('Decryption failed');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const envSwitcher = document.getElementById('env-switcher');
            const statusEl = document.getElementById('cred-status');
            const encryptToggle = document.getElementById('cred-encrypt-toggle');
            const passInput = document.getElementById('cred-passphrase');
            const importFile = document.getElementById('cred-import-file');

            function getSelectedEnv() {
                return localStorage.getItem('selected_env') || (window.Config && window.Config.CURRENT_ENV) || (envSwitcher && envSwitcher.value) || 'production';
            }

            // Check if credentials exist for the selected environment
            function credentialsExistForEnv() {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                const raw = localStorage.getItem(storedKey);
                if (!raw) return false;
                // If encrypted, require passphrase to load, so treat as not set
                try {
                    const parsed = JSON.parse(raw);
                    // Must have at least CLIENT_ID and AUTH_KEY
                    return Boolean(parsed.CLIENT_ID && parsed.AUTH_KEY);
                } catch (e) {
                    // Encrypted or malformed, treat as not set
                    return false;
                }
            }

            // Determine if a stored entry is encrypted by checking if value is a string that doesn't parse as JSON
            function isEncryptedString(val) {
                if (typeof val !== 'string') return false;
                try { JSON.parse(val); return false; } catch (_) { return true; }
            }

            function loadCredentials() {
                const env = getSelectedEnv();
                if (envSwitcher) envSwitcher.value = env;
                const storedKey = 'eximpe_credentials_' + env;
                let raw = localStorage.getItem(storedKey);
                if (!raw) {
                    // fall back to window.Config values
                    document.getElementById('clientId').value = (window.Config && (window.Config.CLIENT_ID || window.Config.CLIENTID || window.Config.CLIENT)) || (window.Config && window.Config.CLIENT_ID) || '';
                    document.getElementById('authKey').value = (window.Config && (window.Config.AUTH_KEY || window.Config.CLIENT_SECRET || window.Config.AUTH_KEY)) || '';
                    document.getElementById('merchantId').value = (window.Config && window.Config.MERCHANT_ID) || '';
                    document.getElementById('isPspCheckbox').checked = false;
                    const _cbEl = document.getElementById('cred-callback-url');
                    if (_cbEl) _cbEl.value = (window.Config && window.Config.CALLBACK_URL) || '';
                    statusEl.textContent = 'No credentials for ' + env;
                    return;
                }

                if (isEncryptedString(raw)) {
                    statusEl.textContent = 'Encrypted credentials found — enter passphrase and click Load';
                    // leave fields alone until decrypted
                    document.getElementById('clientId').value = '';
                    document.getElementById('authKey').value = '';
                    document.getElementById('merchantId').value = '';
                    document.getElementById('isPspCheckbox').checked = false;
                    const _cbEl2 = document.getElementById('cred-callback-url');
                    if (_cbEl2) _cbEl2.value = '';
                } else {
                    try {
                        const parsed = JSON.parse(raw || '{}');
                        document.getElementById('clientId').value = parsed.CLIENT_ID || parsed.API_KEY || '';
                        document.getElementById('authKey').value = parsed.AUTH_KEY || parsed.MERCHANT_SECRET || '';
                        document.getElementById('merchantId').value = parsed.MERCHANT_ID || '';
                        document.getElementById('isPspCheckbox').checked = parsed.IS_PSP ? true : false;
                        const _cbEl3 = document.getElementById('cred-callback-url');
                        if (_cbEl3) _cbEl3.value = parsed.CALLBACK_URL || '';
                        const _vEl = document.getElementById('assetVersion');
                        if (_vEl) _vEl.value = parsed.VERSION || '';
                        statusEl.textContent = 'Loaded credentials for ' + env;
                    } catch (e) {
                        statusEl.textContent = 'Failed to parse stored credentials for ' + env;
                    }
                }
                // toggle merchant id visibility like other pages expect
                const merchantGroup = document.getElementById('merchantIdGroup');
                if (merchantGroup) merchantGroup.style.display = document.getElementById('isPspCheckbox').checked ? 'block' : 'none';
            }

            async function saveCredentials() {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                const payload = {
                    CLIENT_ID: document.getElementById('clientId').value || '',
                    AUTH_KEY: document.getElementById('authKey').value || '',
                    IS_PSP: document.getElementById('isPspCheckbox').checked ? true : false,
                    MERCHANT_ID: document.getElementById('merchantId').value || '',
                    CALLBACK_URL: (document.getElementById('cred-callback-url') ? document.getElementById('cred-callback-url').value : '') || '',
                    VERSION: document.getElementById('assetVersion').value || ''
                };

                if (encryptToggle.checked) {
                    const pass = passInput.value || '';
                    if (!pass) { statusEl.textContent = 'Enter passphrase to encrypt'; return; }
                    try {
                        const enc = await encryptString(JSON.stringify(payload), pass);
                        localStorage.setItem(storedKey, enc);
                        statusEl.textContent = 'Saved (encrypted) credentials for ' + env;
                    } catch (e) {
                        statusEl.textContent = 'Encryption failed';
                    }
                } else {
                    localStorage.setItem(storedKey, JSON.stringify(payload));
                    statusEl.textContent = 'Saved credentials for ' + env;
                }
            }

            async function loadEncryptedWithPassphrase() {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                const raw = localStorage.getItem(storedKey);
                if (!raw || !isEncryptedString(raw)) { statusEl.textContent = 'No encrypted credentials to load'; return; }
                const pass = passInput.value || '';
                if (!pass) { statusEl.textContent = 'Enter passphrase to decrypt'; return; }
                try {
                    const dec = await decryptString(raw, pass);
                    const parsed = JSON.parse(dec || '{}');
                    document.getElementById('clientId').value = parsed.CLIENT_ID || '';
                    document.getElementById('authKey').value = parsed.AUTH_KEY || '';
                    document.getElementById('merchantId').value = parsed.MERCHANT_ID || '';
                    document.getElementById('isPspCheckbox').checked = parsed.IS_PSP ? true : false;
                    const _cbEl4 = document.getElementById('cred-callback-url');
                    if (_cbEl4) _cbEl4.value = parsed.CALLBACK_URL || '';
                    statusEl.textContent = 'Decrypted and loaded for ' + env;
                } catch (e) {
                    statusEl.textContent = 'Decryption failed — bad passphrase?';
                }
            }

            function clearCredentials() {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                localStorage.removeItem(storedKey);
                loadCredentials();
                statusEl.textContent = 'Cleared credentials for ' + env;
            }

            async function exportCredentials() {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                const raw = localStorage.getItem(storedKey);
                if (!raw) { statusEl.textContent = 'No credentials to export for ' + env; return; }
                const blob = new Blob([raw], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `eximpe_credentials_${env}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                statusEl.textContent = 'Exported credentials for ' + env;
            }

            function importCredentialsFile(file) {
                const env = getSelectedEnv();
                const storedKey = 'eximpe_credentials_' + env;
                const reader = new FileReader();
                reader.onload = function (e) {
                    const text = e.target.result;
                    // store as-is (could be encrypted or plain JSON)
                    localStorage.setItem(storedKey, text);
                    loadCredentials();
                    statusEl.textContent = 'Imported credentials for ' + env;
                };
                reader.readAsText(file);
            }

            if (envSwitcher) {
                envSwitcher.value = getSelectedEnv();
                envSwitcher.addEventListener('change', (e) => {
                    const newEnv = e.target.value;
                    localStorage.setItem('selected_env', newEnv);
                    loadCredentials();
                });
            }

            encryptToggle.addEventListener('change', () => {
                passInput.style.display = encryptToggle.checked ? 'inline-block' : 'none';
            });

            // Handle PSP checkbox toggling of merchant ID field
            const isPspCb = document.getElementById('isPspCheckbox');
            if (isPspCb) {
                isPspCb.addEventListener('change', () => {
                    const merchantGroup = document.getElementById('merchantIdGroup');
                    if (merchantGroup) merchantGroup.style.display = isPspCb.checked ? 'block' : 'none';
                });
            }

            document.getElementById('cred-save').addEventListener('click', saveCredentials);
            document.getElementById('cred-clear').addEventListener('click', clearCredentials);
            document.getElementById('cred-export').addEventListener('click', exportCredentials);
            document.getElementById('cred-import-btn').addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) importCredentialsFile(e.target.files[0]); });

            // Wire up the Load Encrypted button in the UI
            const loadEncryptedBtn = document.getElementById('cred-load-encrypted');
            if (loadEncryptedBtn) loadEncryptedBtn.addEventListener('click', loadEncryptedWithPassphrase);

            // Prevent navigation if credentials are not set
            function showCredNotification(msg) {
                const notif = document.getElementById('cred-notification');
                const notifMsg = document.getElementById('cred-notification-msg');
                if (notif && notifMsg) {
                    notifMsg.textContent = msg;
                    notif.style.display = 'flex';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    // Auto-hide after 4 seconds
                    if (notif._timeout) clearTimeout(notif._timeout);
                    notif._timeout = setTimeout(() => { notif.style.display = 'none'; }, 4000);
                }
            }

            function blockIntegrationNavigationIfNoCreds() {
                const integrationLinks = document.querySelectorAll('.integration-card[href]:not([href=""])');
                integrationLinks.forEach(link => {
                    link.addEventListener('click', function (e) {
                        if (!credentialsExistForEnv()) {
                            e.preventDefault();
                            showCredNotification('Set credentials for the selected environment before proceeding.');
                        }
                    });
                });
                // Dismiss button
                const notifClose = document.getElementById('cred-notification-close');
                if (notifClose) {
                    notifClose.addEventListener('click', function () {
                        const notif = document.getElementById('cred-notification');
                        if (notif) notif.style.display = 'none';
                    });
                }
            }

            // initial load
            loadCredentials();
            blockIntegrationNavigationIfNoCreds();
        });
    </script>

</body>

</html>